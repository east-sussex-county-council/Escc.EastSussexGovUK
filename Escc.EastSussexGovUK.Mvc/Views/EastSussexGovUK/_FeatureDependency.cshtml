@using ClientDependency.Core.Mvc
@using Escc.ClientDependencyFramework
@using Escc.Web
@model Escc.EastSussexGovUK.IClientDependencySet
@{
    foreach (var requiredCss in Model.RequiresCss())
    {
        if (String.IsNullOrEmpty(requiredCss.MediaQueryAlias))
        {
            Html.RequiresCss(CssFileAlias.Resolve(requiredCss.CssFileAlias), requiredCss.Priority);
        }
        else
        {
            Html.RequiresCss(CssFileAlias.Resolve(requiredCss.CssFileAlias), requiredCss.Priority, MediaQueryAlias.Resolve(requiredCss.MediaQueryAlias));
        }
    }

    foreach (var requiredJs in Model.RequiresJavaScript())
    {
        Html.RequiresJs(JsFileAlias.Resolve(requiredJs.JsFileAlias), requiredJs.Priority);
    }

    if (!HttpContext.Current.Response.HeadersWritten)
    {
        var config = new ContentSecurityPolicyFromConfig();
        var filter = new ContentSecurityPolicyUrlFilter(Request.Url, config.UrlsToExclude);
        if (filter.ApplyPolicy())
        {
            foreach (var requiredPolicy in Model.RequiresContentSecurityPolicy())
            {
                var policy = new ContentSecurityPolicyHeaders(HttpContext.Current.Response.Headers);
                policy.AppendPolicy(config.Policies[requiredPolicy.Alias]);
                policy.UpdateHeaders();
            }
        }
    }
}