@using System.Collections.Specialized
@using System.Configuration
@using System.Globalization
@using System.Web.Mvc.Html
@using ClientDependency.Core.Mvc
@using Escc.EastSussexGovUK
@using Escc.EastSussexGovUK.Features
@using Escc.EastSussexGovUK.Mvc.Views.EastSussexGovUK
@using Escc.EastSussexGovUK.Views
@using Escc.Net.Configuration
@using Escc.Web
@model Escc.EastSussexGovUK.Mvc.BaseViewModel
@{
    Layout = null;
    if (Model == null)
    {
        throw new NotSupportedException("This view requires a model based on Escc.EastSussexGovUK.Mvc.BaseViewModel");
    }
    Model.EsccWebsiteView = EsccWebsiteView.Desktop;
    Html.RenderPartial("~/Views/EastSussexGovUK/_FeatureDependency.cshtml", Model.EsccWebsiteSkin);

    // In rare circumstances Azure can return a value for Request.Url.Authority which is not correct. Since 
    // Request.Url.Authority is used to load client-side assets, ensure it is always allowed by the content security policy.
    var config = new ContentSecurityPolicyFromConfig();
    var filter = new ContentSecurityPolicyUrlFilter(Request.Url, config.UrlsToExclude);
    if (filter.ApplyPolicy() && !Response.HeadersWritten)
    {
        new ContentSecurityPolicyHeaders(Response.Headers)
            .AppendPolicy($"script-src {Request.Url.GetLeftPart(UriPartial.Authority)}; style-src {Request.Url.GetLeftPart(UriPartial.Authority)}; img-src {Request.Url.GetLeftPart(UriPartial.Authority)}")
            .UpdateHeaders();
    }

    // Configure the client that loads elements of the remote master page
    var textSize = new TextSize(Request.Cookies?["textsize"]?.Value, Request.QueryString).CurrentTextSize();
    var isLibraryCatalogueRequest = new LibraryCatalogueContext(Request.UserAgent).RequestIsFromLibraryCatalogueMachine();
    var proxyProvider = new ConfigurationProxyProvider();
    var remoteMasterPageConfig = ConfigurationManager.GetSection("Escc.EastSussexGovUK/RemoteMasterPage") as NameValueCollection;
    if (remoteMasterPageConfig == null || String.IsNullOrEmpty(remoteMasterPageConfig["MasterPageControlUrl"]))
    {
        throw new ConfigurationErrorsException("<Escc.EastSussexGovUK><RemoteMasterPage><add key=\"MasterPageControlUrl\" /></RemoteMasterPage></Escc.EastSussexGovUK> is not defined in web.config");
    }
    var remoteMasterPageRequestTimeout = 4000;
    if (!String.IsNullOrEmpty(remoteMasterPageConfig["Timeout"]))
    {
        Int32.TryParse(remoteMasterPageConfig["Timeout"], out remoteMasterPageRequestTimeout);
    }

    var forceCacheRefresh = (Request.QueryString["ForceCacheRefresh"] == "1"); // Provide a way to force an immediate update of the cache
    var masterPageControlProvider = new RemoteMasterPageHtmlProvider(new Uri(remoteMasterPageConfig["MasterPageControlUrl"], UriKind.RelativeOrAbsolute), proxyProvider, Request.UserAgent, remoteMasterPageRequestTimeout, new RemoteMasterPageMemoryCacheProvider(), forceCacheRefresh);
}
@if (IsSectionDefined("WebChat"))
{
    @RenderSection("WebChat")
}
else
{
    // Support web chat - not ideal to do this in the view but there's no common controller
    var context = new HostingEnvironmentContext(Request.Url);
    if (context.WebChatSettingsUrl != null)
    {
        var webChat = new WebChat();
        webChat.WebChatSettings = new WebChatSettingsFromApi(context.WebChatSettingsUrl, proxyProvider, new ApplicationCacheStrategy<WebChatSettings>(TimeSpan.FromMinutes(context.WebChatSettingsCacheDuration))).ReadWebChatSettings();
        webChat.WebChatSettings.PageUrl = new Uri(Request.Url.AbsolutePath, UriKind.Relative);
        Html.RenderPartial("~/Views/EastSussexGovUK/_FeatureDependencies.cshtml", new[] { webChat });
    }
}
@{ Html.RenderPartial("~/Views/EastSussexGovUK/_MasterPageControl.cshtml", new MasterPageControlData {Control = "HtmlTag", BreadcrumbProvider = Model.BreadcrumbProvider, HtmlControlProvider = masterPageControlProvider, TextSize = textSize, IsLibraryCatalogueRequest = isLibraryCatalogueRequest }); }
<head>
    @RenderSection("ContentExperiment", required: false)
    @{
        Html.RenderPartial("~/Views/EastSussexGovUK/_MasterPageControl.cshtml", new MasterPageControlData {Control = "MetadataDesktop", BreadcrumbProvider = Model.BreadcrumbProvider, HtmlControlProvider = masterPageControlProvider, TextSize = textSize, IsLibraryCatalogueRequest = isLibraryCatalogueRequest });
        Html.RenderPartial("~/Views/EastSussexGovUK/MetadataControl.ascx", Model.Metadata);
        Html.RenderPartial("~/Views/EastSussexGovUK/_Fonts.cshtml", Model.EsccWebsiteSkin);
    }
    @Html.RenderCssHere()
    @RenderSection("Metadata", required: false)
</head>
@{
    var bodyClass = String.Empty;
    if (IsSectionDefined("BodyClass"))
    {
        using (var writer = new StringWriter())
        {
            RenderSection("BodyClass", required: false).WriteTo(writer);
            bodyClass = writer.ToString();
        }
    }
    
    if (textSize > 1)
    {
        bodyClass += " size" + textSize.ToString(CultureInfo.InvariantCulture);
    }

    if (!String.IsNullOrEmpty(bodyClass))
    {
        @:<body class="@bodyClass.Trim()">
    }
    else
    {
        @:<body>
    }
    Html.RenderPartial("~/Views/EastSussexGovUK/_MasterPageControl.cshtml", new MasterPageControlData {Control = "AboveHeaderDesktop", BreadcrumbProvider = Model.BreadcrumbProvider, HtmlControlProvider = masterPageControlProvider, TextSize = textSize, IsLibraryCatalogueRequest = isLibraryCatalogueRequest });
}
@if (IsSectionDefined("Header"))
{
    @RenderSection("Header")
}
else
{
    Html.RenderPartial("~/Views/EastSussexGovUK/_MasterPageControl.cshtml", new MasterPageControlData {Control = "HeaderDesktop", BreadcrumbProvider = Model.BreadcrumbProvider, HtmlControlProvider = masterPageControlProvider, TextSize = textSize, IsLibraryCatalogueRequest = isLibraryCatalogueRequest });
}
<div id="main" role="main" class="body">
    <div class="container">
        @if (IsSectionDefined("Breadcrumb"))
        {
            @RenderSection("Breadcrumb")
        }
        else
        {
            Html.RenderPartial("~/Views/EastSussexGovUK/_BreadcrumbTrail.cshtml", Model.BreadcrumbProvider);
            Html.RenderPartial("~/Views/EastSussexGovUK/_BreadcrumbTrailMobile.cshtml", Model.BreadcrumbProvider);
        }
        @RenderBody()
    </div>
</div>
@if (IsSectionDefined("Footer"))
{
    @RenderSection("Footer")
}
else
{
    Html.RenderPartial("~/Views/EastSussexGovUK/_MasterPageControl.cshtml", new MasterPageControlData {Control = "FooterDesktop", BreadcrumbProvider = Model.BreadcrumbProvider, HtmlControlProvider = masterPageControlProvider, TextSize = textSize, IsLibraryCatalogueRequest = isLibraryCatalogueRequest });
}
@{ Html.RenderPartial("~/Views/EastSussexGovUK/_MasterPageControl.cshtml", new MasterPageControlData {Control = "ScriptsDesktop", BreadcrumbProvider = Model.BreadcrumbProvider, HtmlControlProvider = masterPageControlProvider, TextSize = textSize, IsLibraryCatalogueRequest = isLibraryCatalogueRequest }); }
@Html.RenderJsHere()
@RenderSection("JavaScript", required: false)
</body>
</html>
